<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>USFTT - Résultats par équipes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .container { max-width: 1400px; }
        .nav-link.active { font-weight: bold; }
        .team-title { margin-top: 30px; margin-bottom: 20px; }
        .victory { color: #198754; font-weight: bold; }
        .defeat { color: #dc3545; font-weight: bold; }
        .draw { color: #6c757d; font-weight: bold; }
        .match-cell { padding: 8px; text-align: center; }
        .match-home { background-color: #e9ecef; }
        .match-away { background-color: #f8f9fa; }
        .table-responsive { overflow-x: auto; }
        .tour-header { min-width: 120px; text-align: center; }
        .team-name { font-weight: bold; }
        .division-name { font-weight: bold; color: #6c757d; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="index.html">USFTT</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="classement.html">Classement individuel</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="equipes.html">Résultats par équipes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tests.html">Tests</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4">Résultats par équipes</h1>
        
        <div class="row mb-3">
            <div class="col">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-filter="all">Toutes les équipes</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="G">Équipes masculines</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="F">Équipes féminines</button>
                </div>
            </div>
        </div>

        <div id="teams-container"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        async function loadMatchData() {
            try {
                const response = await fetch('backend/rencontres_08940073.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].trim().split(',');
                
                const data = lines.slice(1).filter(line => line.trim()).map(line => {
                    const values = line.split(',');
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    return obj;
                });

                // Group by team
                const teams = {};
                data.forEach(match => {
                    if (!teams[match.team_id]) {
                        teams[match.team_id] = {
                            id: match.team_id,
                            name: match.team_name,
                            division: match.division,
                            gender: match.team_id.slice(-1),
                            matches: {}
                        };
                    }
                    teams[match.team_id].matches[match.tour] = match;
                });

                return teams;
            } catch (error) {
                console.error('Error loading CSV:', error);
                return null;
            }
        }

        function createTeamsTable(teams) {
            const allTours = new Set();
            Object.values(teams).forEach(team => {
                Object.keys(team.matches).forEach(tour => allTours.add(tour));
            });
            const tours = Array.from(allTours).sort((a, b) => parseInt(a) - parseInt(b));
            
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-responsive';
            
            const table = document.createElement('table');
            table.className = 'table table-bordered';
            
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const divisionHeader = document.createElement('th');
            divisionHeader.className = 'tour-header';
            divisionHeader.textContent = 'Division';
            headerRow.appendChild(divisionHeader);

            const teamHeader = document.createElement('th');
            teamHeader.className = 'tour-header';
            teamHeader.textContent = 'Équipe';
            headerRow.appendChild(teamHeader);
            
            tours.forEach(tour => {
                const th = document.createElement('th');
                th.className = 'match-cell';
                th.textContent = `Tour ${tour}`;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            
            Object.values(teams).forEach(team => {
                const row = document.createElement('tr');
                row.className = 'team-section';
                row.setAttribute('data-gender', team.gender);
                
                const divisionCell = document.createElement('td');
                divisionCell.className = 'division-name';
                divisionCell.textContent = team.division;
                row.appendChild(divisionCell);

                const teamCell = document.createElement('td');
                teamCell.className = 'team-name';
                teamCell.textContent = team.id;
                row.appendChild(teamCell);
                
                tours.forEach(tour => {
                    const cell = document.createElement('td');
                    cell.className = 'match-cell';
                    
                    const match = team.matches[tour];
                    if (match) {
                        const isHome = (match.is_home || '').trim() === 'True';
                        cell.className += ` ${isHome ? 'match-home' : 'match-away'}`;
                        
                        const opponent = isHome ? match.equipe_exterieur : match.equipe_domicile;
                        const opponentDiv = document.createElement('div');
                        opponentDiv.textContent = opponent;
                        cell.appendChild(opponentDiv);
                        
                        const scoreDiv = document.createElement('div');
                        let resultClass = '';
                        
                        if (match.score_domicile && match.score_exterieur) {
                            const homeScore = parseInt(match.score_domicile);
                            const awayScore = parseInt(match.score_exterieur);
                            
                            if (homeScore === awayScore) {
                                resultClass = 'draw';
                            } else if ((isHome && homeScore > awayScore) || (!isHome && awayScore > homeScore)) {
                                resultClass = 'victory';
                            } else {
                                resultClass = 'defeat';
                            }
                            
                            scoreDiv.textContent = isHome ? 
                                `${match.score_domicile}-${match.score_exterieur}` :
                                `${match.score_exterieur}-${match.score_domicile}`;
                        } else {
                            scoreDiv.textContent = 'À venir';
                        }
                        
                        scoreDiv.className = resultClass;
                        cell.appendChild(scoreDiv);
                        
                        const locationDiv = document.createElement('div');
                        locationDiv.innerHTML = `<small>${isHome ? 'Dom.' : 'Ext.'}</small>`;
                        cell.appendChild(locationDiv);
                    } else {
                        cell.innerHTML = '<div>-</div>';
                    }
                    
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            tableWrapper.appendChild(table);
            
            return tableWrapper;
        }

    async function initializePage() {
            const teams = await loadMatchData();
            if (!teams) return;

            const container = document.getElementById('teams-container');
            
            // Sort teams by ID
            const sortedTeams = {};
            Object.values(teams).sort((a, b) => {
                const aId = parseInt(a.id.replace(/[FG]$/, ''));
                const bId = parseInt(b.id.replace(/[FG]$/, ''));
                return aId - bId;
            }).forEach(team => {
                sortedTeams[team.id] = team;
            });

            // Clear container first
            container.innerHTML = '';
            
            // Create and add the single table with all teams
            const teamsTable = createTeamsTable(sortedTeams);
            container.appendChild(teamsTable);

            // Filter functionality
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.btn-group .btn').forEach(b => 
                        b.classList.remove('active')
                    );
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    const sections = document.querySelectorAll('.team-section');
                    
                    sections.forEach(section => {
                        if (filter === 'all' || section.getAttribute('data-gender') === filter) {
                            section.style.display = '';
                        } else {
                            section.style.display = 'none';
                        }
                    });
                });
            });
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>